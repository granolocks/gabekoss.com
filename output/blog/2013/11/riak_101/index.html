<!doctype html>
<html>
  <head>
    <title>Riak 101</title>
<link type='text/css' href='/style.css' rel='stylesheet'/> <link rel="stylesheet" href="/css/zenburn.css">
<meta property="og:title" content="Riak 101" />
<meta property="og:url" content="http://www.gabekoss.com/blog/2013/11/riak_101/" />
<meta property="og:type" content="website" />
<meta property="og:description" content="A simple introduction to Riak based on a presentation I gave with Sam Stelfox at a Burlington Web Development Group meetup." />
<meta property="og:image" content="http://www.gabekoss.com/images/og.png" />

  <script src="/js/highlight-pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

<!--                                                                                              -->
<!--       ___ ___         .__  .__           ___________      .__                   .___._.      -->
<!--      /   |   \   ____ |  | |  |   ____   \_   _____/______|__| ____   ____    __| _/| |      -->
<!--     /    ~    \_/ __ \|  | |  |  /  _ \   |    __) \_  __ \  |/ __ \ /    \  / __ | | |      -->
<!--     \    Y    /\  ___/|  |_|  |_(  <_> )  |     \   |  | \/  \  ___/|   |  \/ /_/ |  \|      -->
<!--      \___|_  /  \___  >____/____/\____/   \___  /   |__|  |__|\___  >___|  /\____ |  __      -->
<!--            \/       \/                        \/                  \/     \/      \/  \/      -->
<!--                                                                                              -->
<!--                                                                                              -->
<!--     My sweet site was generated using love, ruby & nanoc [http://nanoc.ws/]                  -->
<!--                                                                                              -->
<!--                                                                                              -->
<!--     "Anytime I see something screech across a room and latch onto someones neck,             -->
<!--     and the guy screams and tries to get it off, I have to laugh,                            -->
<!--     because what is that thing?"                                                             -->
<!--                                                                                              -->
<!--                           - Jack Handy                                                       -->
<!--                                                                                              -->

  </head>
  <body>
    <div id="sidebar">
      <ul>
  <li><a href="/">Home</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/notes">Notes</a></li>
  <li><a href="/tags">Search</a></li>
</ul>
<div class="img-links">
  <a href="https://github.com/granolocks"><img src="/images/github.png"></a>
  <a href="https://twitter.com/granolocks"><img src="/images/twitter.png"></a>
  <div style="clear:both"></div>
</div>

    </div>
    <div id="main">
      
      
      
        <p>
          <small>
            
              <a href='/blog/2013/11/introduction_to_elastic_search/' title='Introduction To Elastic Search'>&#8656; Previous</a>
            
             | 
            
              <a href='/blog/2013/11/be_your_own_boss/' title='Be Your Own Boss'>Next &#8658;</a>
            
          </small> 
        </p>
        <h1>Riak 101</h1>
        <p><em>Post created 2013-11-21 16:30 by Gabe Koss.<br/></em></p>
        <p>Riak is a distributed key-value store written in Erlang. Development is carried
out primarily by a company called <a href="http://basho.com">Basho technologies</a></p>

<p>I first became aware of Riak when searching for solutions to complex data
storage issues we started to encounter dealing with large volumes of JSON data.
Because we were researching the solution. <a href="http://stelfox.net">Sam Stelfox</a> and
I volunteered to give a presentation on the database at a
<a href="http://twitter.com/btvwag">@btvwag</a> meetup.</p>

<p>Most of this content is derived from the <a href="/riak_slides.pdf">slides from the presentation</a>.</p>

<h2>NoSQL, huh?</h2>

<p>The event where we gave this presentation was a meeting on varion NoSQL
technogogies. We started with the following quotes from Andy Gross:</p>

<blockquote>
<p>&quot;NoSQL marketing is confusing... Everything does everything and at a small scale everything works.&quot;</p>

<p>&quot;If you&#39;re evaluating Mongo vs. Riak or Couch vs.  Cassandra you don&#39;t understand either your problem or the technologies.&quot;</p>

<p><em>Andy Gross, VP of Engineering, Basho Technologies</em></p>

<p><em>(approximate paraphrasing, hopefully not grossly misquoted)</em></p>
</blockquote>

<p>NoSQL is often cited as a sort of &#39;magic bullet&#39; by both marketers and
engineers. These technologies are generally less mature than their conventional
&amp; relational cousins. As such it is often a problem where tools which have
significant differences between them are compared against each other for
problems which neither one solves.</p>

<p>As developers it is crucial to understand our problems fully before we move on
technologies which may or may not suit our purposes.</p>

<h2>So what is Riak then?</h2>

<p>Riak offers quite a lot. It is a REST-ful Key-Value store with some internal
intelligence. As far as I have been able to decipher it&#39;s most significant
features are as follows:</p>

<ul>
<li>HTTP access</li>
<li>Simple Key-Value Database</li>
<li>Masterless Clustering</li>
<li>CAP Tuning</li>
<li>Map/Reduce using Javascript or Erlang</li>
<li>Automatic Sharding / Consistent Hashing</li>
</ul>

<p>Other features which I will not dig into in this article include full text
search via Solr, link walking, commit hooks for data processing and a
secondary/ custom indexing system.</p>

<h2>Key-Value Heaven</h2>

<p>Since it is HTTP based it uses a URL scheme to organize keys and values into
data buckets. Buckets are not strictly defined like tables in relational databases. </p>

<p>The basic URL scheme looks like: <code>http://riak-node-hostname:8098/riak/&lt;bucket-name&gt;/&lt;key-name&gt;</code></p>

<p>This scheme dictates that actual internals of the Riak internal data models
which is basically made up of the following:</p>

<ul>
<li>Bucket Name</li>
<li>Key Name</li>
<li>Binary Data</li>
<li>Indexes</li>
<li>Additional Metadata </li>
</ul>

<h3>Simple Example</h3>

<p>A basic PUT / GET operation to save some data into a bucket looks like this:</p>

<pre><code class="bash">$ curl -XPUT &quot;http://localhost:8098/riak/my-bucket/my-key&quot;\
  --header &quot;Content-Type: application/json&quot; \
  --data &#39;{&quot;living_in&quot;:&quot;the future!&quot;}&#39;

$ curl -XGET &quot;http://localhost:8098/riak/my-bucket/my-key&quot;
  {&quot;living_in&quot;:&quot;the future!&quot;}
</code></pre>

<p>In this example a JSON blob containing <code>&#39;{&quot;living_in&quot;:&quot;the future!&quot;}&#39;</code> is
stored in the <code>my-bucket</code> bucket with the key <code>my-key</code>. It is then retrieved
using the same bucket/key combo.</p>

<h3>Binary Data</h3>

<p>The simplicity of the data model at Riaks core allows for very simple saving of
other filetypes. Here is an example of posting an image of a horse into the
<code>images</code> bucket with the key <code>horse.jpg</code>:</p>

<pre><code class="bash">$ curl -XPUT &quot;http://localhost:8098/riak/images/horse.jpg&quot;\
  --header &quot;Content-Type: image/jpeg&quot; \
  --data-binary @/home/user/horse_pic.jpg

$ curl -XGET &quot;http://localhost:8098/riak/images/horse.jpg&quot; &gt; /home/user/new_horse.jpg

$ md5sum /home/user/horse_pic.jpg
3f9bdc9366aec1f98839f47717ada5bf horse_pic.jpg

$ md5sum /home/user/new_horse.jpg
3f9bdc9366aec1f98839f47717ada5bf new_horse.jpg
</code></pre>

<p>After posting in the binary data an retrieving it we see that the MD5 checksum
matches which indicates that the image was stored and retrieved properly.</p>

<h2>It&#39;s distributed right?</h2>

<h3>The Ring</h3>

<p>The primary way which Riak handles distributed clustering is a mechanism called
&#39;The Ring&#39;. Riak splits its data into a series of partitions (default is 32).
Data is hashed using the Bucket/Key combination in a repeatable way. This hash
effectively becomes the unique identifier </p>

<p>The partitions are applied evenly across all nodes of the cluster as a ring.
For example if there were four nodes, Node 1 would be assigned partitions 1, 5,
9 ... and so forth.</p>

<p>Data is also saved across redundant nodes </p>

<p><img src="/images/riak_ring.png" alt="Riak Ring"></p>

<p><small><strong>image source:
<a href="http://docs.basho.com/shared/1.4.2/images/riak-ring.png">http://docs.basho.com/shared/1.4.2/images/riak-ring.png</a></strong></small></p>

<h3>Where does it fit on the CAP spectrum?</h3>

<p>CAP theorem is the idea that in a system where you need to maintain tolerance
to network partitions you can effectively choose any two of the following: </p>

<ul>
<li><strong>C</strong>onsistency</li>
<li><strong>A</strong>vailability</li>
<li><strong>P</strong>artition Tolerance</li>
</ul>

<blockquote>
<p>&quot;If you have a system that can get a network partition you have a choice: do
you want to be consistent or do you want to be available?&quot;</p>

<p><em>Martin Fowler</em></p>
</blockquote>

<p>Generally any sort of distributed database system will optimize for either CP
or AP. Riak does not make this decision for you.</p>

<h3>Tuning for CAP</h3>

<p>There are several properties which can be applied to Riak system wide, bucket
wide or on a per data value basis. This allows for the Riak cluster performance
to be tightly coupled to the type of data being stored in it.</p>

<ul>
<li><code>n</code>: Copies of each nodes a given key must be stored on</li>
<li><code>r</code>: Number of nodes which must agree on a value for a read to be considered valid</li>
<li><code>w</code>: Number of nodes that must confirm receipt for a write to be considered valid</li>
</ul>

<p>There are also two advanced options: <code>dw</code> and <code>rw</code>.</p>

<h4>Optimize for Consistency and Availability</h4>

<pre><code class="json">{
  n_val: &quot;&lt;all&gt;&quot;,
  r_val: &quot;1&quot;,
  w_val: &quot;&lt;all&gt;&quot;
}
</code></pre>

<h4>Optimize for Consistency and Partition Tolerance</h4>

<pre><code class="json">{
  n_val: &quot;&lt;high value&gt;&quot;,
  r_val: &quot;&lt;n_val quorum+&gt;&quot;,
  w_val: &quot;&lt;n_val quorum+&gt;&quot;
}
</code></pre>

<h4>Optimize for Availability and Partition Tolerance</h4>

<pre><code class="json">{
  n_val: &quot;&lt;high value&gt;&quot;,
  r_val: &quot;&lt;low value&gt;&quot;,
  w_val: &quot;&lt;low value&gt;&quot;
}

</code></pre>

<h2>A few more samples</h2>

<h3>Ruby Client</h3>

<p>Since I use a lot of Ruby the first thing I checked out was a Ruby client.
There is a client gem which can be installed via <code>gem install riak-client</code>. </p>

<p>The project source is <a href="https://github.com/basho/riak-ruby-client">here</a>. It
does not seem as active as I&#39;d like. Here is a sample anyway:</p>

<pre><code class="ruby">require &#39;rubygems&#39;
require &#39;riak&#39;

# Create a client for localhost
@client = Riak::Client.new

# Specify a bucket
@bucket = @client.bucket(&#39;sample-bucket&#39;)

# Build an object
@object = @bucket.get_or_new(&#39;sample-key&#39;)
@object.content_type = &#39;application/json&#39;
@object.data = &#39;{&quot;sample&quot;:&quot;data&quot;}&#39;
@object.store

# Access the object
@bucket.get(&#39;sample-key&#39;)
#=&gt; #&lt;Riak::RObject {sample-bucket,sample-key} [#&lt;Riak::RContent [application/json]:&quot;{\&quot;sample\&quot;:\&quot;data\&quot;}&quot;&gt;]&gt;
</code></pre>

<h3>Simple Map Reduce</h3>

<p>The second functionality I wanted to investigate was the MapReduce
functionality. </p>

<p>Chains of functions (written in Javascript or Erlang) are sent in and
distributed amongst the nodes. The nodes run the query against their own Keys
and Values and</p>

<p>For a general MapReduce overview take a look at the <a href="http://en.wikipedia.org/wiki/MapReduce">Wikipedia article</a>.</p>

<p>Start by seeding some simple sample data as follows. Note bucket is <code>users</code>,
key is the user email and then the data is simply some basic information.</p>

<pre><code class="bash">$ curl -XPUT &quot;http://localhost:8098/riak/users/btables@gmail.com&quot;\
  --header &quot;Content-Type: application/json&quot; \
  --data &#39;{
    &quot;first_name&quot;:&quot;Bobby&quot;,
    &quot;last_name&quot;:&quot;Tables&quot;
  }&#39;

# do this a few more times ...
</code></pre>

<p>A Map or Reduce query can pull this data out in a new format:</p>

<pre><code class="bash">$ curl -XPOST &quot;http://localhost:8098/mapred&quot;\
  --header &quot;Content-Type: application/json&quot; \
  --data &#39;{
    &quot;inputs&quot;:&quot;users&quot;,
    &quot;query&quot;:[{
      &quot;map&quot;:{
        &quot;language&quot;:&quot;javascript&quot;,
        &quot;source&quot;:&quot;function(record) {
          var record_data = JSON.parse(record.values[0].data);
          return [[
              record.key,
              record_data.first_name,
              record_data.last_name
            ]];
        }&quot;}}]}&#39;

# Returns:
# 
# [ [&quot;gabe@gabekoss.com&quot;,  &quot;Gabe&quot;,   &quot;Koss&quot;   ],
#   [&quot;sam@stelfox.net&quot;,    &quot;Sam&quot;,    &quot;Stelfox&quot;],
#   [&quot;btables@gmail.com&quot;,  &quot;Bobby&quot;,  &quot;Tables&quot; ]  ]
</code></pre>

<h2>Summary</h2>

<p>Overall we ended up not using Riak. At least not yet. In general I think it is
a strong system when it meets your needs. </p>

<p>Use Riak for...</p>

<ul>
<li>Clustered operations</li>
<li>Straight key-value gets &amp; puts</li>
<li>Sibling resolution / link walking</li>
</ul>

<p>Don&#39;t use Riak for...</p>

<ul>
<li>Key listing / Bucket enumeration (<code>MyRiakObject.all() == :bad</code>)</li>
<li>Mass deletion from certain backends</li>
<li>Large map-reduce in real-time operations</li>
</ul>

<h2>Additional Resources</h2>

<ul>
<li><a href="https://basho.com/">Basho Technologies</a>: Makers of Riak</li>
<li><a href="https://twitter.com/seancribbs">Sean Cribs</a>: Riak evangelist, overall smart dude</li>
<li><a href="http://littleriakbook.com/">Little Riak Book</a>: Tells you way more than I just did in a very succinct fashion</li>
<li><a href="http://learnyousomeerlang.com/">Learn You Some Erlang for Great Good</a></li>
<li><a href="http://stelfox.net">Sam Stelfox</a>: My friend and partner in crime for this presentation</li>
<li><a href="/riak_slides.pdf">Slides from the Talk</a>: PDF from our presentation</li>
<li><a href="/notes/riak">Install Riak on Ubuntu</a></li>
</ul>

        <div id="disqus_thread"></div>
<script type="text/javascript">
var disqus_shortname = 'gabekoss'; 

(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

      
    </div>
    <div id="footer">
      <hr/>
<p>&copy; 2014 <a href="mailto:gabe@gabekoss.com">Gabe Koss</a></p>

  <p><small>Last updated at: 2013-11-21 16:45</small></p>


    </div>
  </body>
   
  <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-12795044-1']);
  _gaq.push(['_setDomainName', 'gabekoss.com']);
  _gaq.push(['_trackPageview']);

  (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
   })();
</script>

</html>

