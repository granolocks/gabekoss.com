
<!doctype html>
<html>
  <head>
    <title></title>
    <link type='text/css' href='/css/notes.css' rel='stylesheet'/>
  </head>
  <body>
    <div id="some-text-yo">
      <h1 id="ubuntu-1204-rails-server">Ubuntu 12.04 Rails Server</h1>

<h2 id="install-from-iso">Install from ISO</h2>
<p>Installing from an Ubuntu 12.04 64bit ISO I opted to install several packages:</p>

<ul>
  <li>OpenSSH Server</li>
  <li>Postgres</li>
</ul>

<h2 id="install-helpful-packages-i-like">Install helpful packages I like</h2>

<p>Just a few packages I want to make sure are on the system.</p>

<p>Gotta have my pops…</p>

<p><code>sh
sudo apt-get -y update
sudo apt-get -y install tmux vim git tree build-essential zlib1g-dev libssl-dev libreadline-dev libyaml-dev libcurl4-openssl-dev curl git-core python-software-properties
</code></p>

<h2 id="enable-ufw-c">Enable UFW :C</h2>

<p>I don’t like <code>ufw</code> but I probably need it…</p>

<p><code>sh
sudo ufw enable
sudo ufw status verbose
sudo ufw allow ssh
sudo ufw allow http
</code></p>

<h2 id="shared-memory">Shared Memory</h2>

<p>Secure shared memory in <code>/dev/shm</code> by adding the following line to the bottom
of <code>/etc/fstab</code>. </p>

<p><code>
tmpfs     /dev/shm     tmpfs     defaults,noexec,nosuid     0     0
</code></p>

<p>A reboot is required.</p>

<h2 id="securing-ssh">Securing SSH</h2>

<p>In <code>/etc/ssh/sshd_config</code> make the following changes:</p>

<p><code>
Port &lt;new_port&gt;
PermitRootLogin no
DebianBanner no
</code></p>

<p>A restart of the ssh service is now required. </p>

<p><code>sh
sudo service ssh restart
</code></p>

<h2 id="restrict-su-privileges-to-admin-group">Restrict <code>su</code> privileges to admin group</h2>
<p><code>sh
sudo groupadd admin
sudo usermod -a -G admin &lt;admin user&gt;
sudo dpkg-statoverride --update --add root admin 4750 /bin/su
</code></p>

<h2 id="setting-up-the-deploy-user">Setting up the deploy user</h2>

<p>Create a user <code>deploy</code> to run the rails app.</p>

<p><code>sh
sudo adduser deploy
</code></p>

<h2 id="install-ruby">Install Ruby</h2>

<p><code>sh
wget http://ftp.ruby-lang.org/pub/ruby/1.9/ruby-1.9.3-p448.tar.gz
tar -xvzf ruby-1.9.3-p447.tar.gz
cd ruby-1.9.3-p447/
./configure
make
sudo make install
echo "gem: --no-ri --no-rdoc" &gt;&gt; ~/.gemrc
sudo gem install bundler
</code></p>

<h2 id="install-passenger--nginx">Install Passenger + nginx</h2>

<p><code>sh
sudo gem install passenger
sudo passenger-install-nginx-module
</code></p>

<p>In the nginx module installation process press <code>enter</code> at the first screen,
then select <code>1. Yes: download, compile and install Nginx for me. (recommended)</code>
when prompted. Press <code>enter</code> to continue selecting defaults until installation
completes.</p>

<h3 id="nginx-init-script">nginx init script</h3>

<p>Place this script (or something like it) in <code>/etc/init.d/nginx</code></p>

<p>After setting the script file, run: </p>

<p><code>sh
sudo chmod +x /etc/init.d/nginx
sudo /usr/sbin/update-rc.d -f nginx defaults
</code></p>

<h4 id="script-body">Script Body:</h4>

<p>```sh
#! /bin/sh</p>

<h3 id="begin-init-info">BEGIN INIT INFO</h3>
<p># Provides:          nginx
# Required-Start:    $all
# Required-Stop:     $all
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: starts the nginx web server
# Description:       starts nginx using start-stop-daemon
### END INIT INFO</p>

<h1 id="original-source-httplibrarylinodecomassets660-init-debsh">Original source: http://library.linode.com/assets/660-init-deb.sh</h1>

<p>PATH=/opt/nginx/sbin:/sbin:/bin:/usr/sbin:/usr/bin
DAEMON=/opt/nginx/sbin/nginx
NAME=nginx
DESC=nginx</p>

<table>
  <tbody>
    <tr>
      <td>test -x $DAEMON</td>
      <td> </td>
      <td>exit 0</td>
    </tr>
  </tbody>
</table>

<h1 id="include-nginx-defaults-if-available">Include nginx defaults if available</h1>
<p>if [ -f /etc/default/nginx ] ; then
  . /etc/default/nginx
fi</p>

<p>set -e</p>

<p>case “$1” in
  start)
    echo -n “Starting $DESC: “
    start-stop-daemon –start –quiet –pidfile /opt/nginx/logs/$NAME.pid \
            –exec $DAEMON – $DAEMON_OPTS
    echo “$NAME.”
    ;;
  stop)
    echo -n “Stopping $DESC: “
    start-stop-daemon –stop –quiet –pidfile /opt/nginx/logs/$NAME.pid \
            –exec $DAEMON
    echo “$NAME.”
    ;;
  restart|force-reload)
    echo -n “Restarting $DESC: “
    start-stop-daemon –stop –quiet –pidfile \
            /opt/nginx/logs/$NAME.pid –exec $DAEMON
    sleep 1
    start-stop-daemon –start –quiet –pidfile \
            /opt/nginx/logs/$NAME.pid –exec $DAEMON – $DAEMON_OPTS
    echo “$NAME.”
    ;;
  reload)
    echo -n “Reloading $DESC configuration: “
    start-stop-daemon –stop –signal HUP –quiet –pidfile     /opt/nginx/logs/$NAME.pid \
        –exec $DAEMON
    echo “$NAME.”
    ;;
  *)
    N=/etc/init.d/$NAME
    echo “Usage: $N {start|stop|restart|reload|force-reload}” &gt;&amp;2
    exit 1
    ;;
esac</p>

<p>exit 0
```</p>

<h3 id="postgres">Postgres</h3>

<p>Just make sure everything is there:</p>

<p><code>sh
sudo apt-get -y install postgresql libpq-dev
</code></p>

<p>Set up the database:</p>

<p><code>sh
sudo -u postgres psql
</code></p>

<p><code>sql
CREATE USER username WITH PASSWORD 'password';
ALTER ROLE username superuser createrole createdb replication;
CREATE DATABASE projectname_production OWNER username;
</code></p>

<h3 id="nodejs">Nodejs</h3>
<p><code>sh
sudo apt-add-repository ppa:chris-lea/node.js
sudo apt-get -y update
sudo apt-get -y install nodejs`
</code></p>

<h3 id="configure-nginxconf">Configure nginx.conf</h3>

<p>Add something like the following to <code>/opt/nginx/conf/nginx.conf</code>
<code>
server {
  listen 80;
  server_name my-domain.com;
  root /home/deploy/www/public;   
  passenger_enabled on;
}
</code></p>

<h3 id="capistrano">Capistrano</h3>

<p>First go into the project and add the following to <code>Gemfile</code>.</p>

<p><code>ruby 
gem 'capistrano'
gem 'capistrano-ext'
</code>
Once added:</p>

<p><code>sh
bundle install
capify .
</code></p>

<p>Configure SSH forwarding and then update the application <code>config/deploy.rb</code> as follows:
```ruby
require “bundler/capistrano”</p>

<p>set :repository, “git@github.com:granolocks/roots-crm.git”  # Your clone URL
set :scm, “git”
set :user, “deploy”  # The server’s user for deploys
set :ssh_options, { :forward_agent =&gt; true, :port =&gt; 55522 }
set :branch, “master”
set :deploy_via, :remote_cache
set :deploy_to, “/home/#{user}/www”
set :use_sudo, false</p>

<p>role :app, “192.168.1.102”
role :web, “192.168.1.102”
role :db, “192.168.1.102”, :primary =&gt; true</p>

<p>task :ls do
  run “ls ~”
end
```</p>

<p>Once you have configure <code>config/database.yml</code> with the right postgres info
run something like</p>

<p><code>sh
cap deploy:setup
cap deploy
</code></p>

<h4 id="sources">Sources</h4>

<p>These notes were culled from two primary sources in addition to my own process +
ordering + additional notes.</p>

<ul>
  <li><a href="http://www.thefanclub.co.za/how-to/how-secure-ubuntu-1204-lts-server-part-1-basics">How to Secure Ubuntu 1204 LTS
Server</a></li>
  <li><a href="http://excid3.com/blog/setting-up-ubuntu-12-04-with-ruby-1-9-3-nginx-passenger-and-postgresql-or-mysql/">Setting Up Ubuntu 12.04 with ruby 1.9.3 nginx passenger and
postgres</a></li>
  <li><a href="https://github.com/capistrano/capistrano/wiki/2.x-From-The-Beginning">Capistrano 2.x From the Begining</a></li>
  <li><a href="https://coderwall.com/p/yz8cha">Deploying Rails app using Nginx, Unicorn, Postgres and Capistrano to Digital Ocean</a></li>
</ul>

    </div>
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-12795044-1']);
      _gaq.push(['_setDomainName', 'gabekoss.com']);
      _gaq.push(['_trackPageview']);

      (function() {
       var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
       ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
       var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
       })();

     </script>
   </body>
 </html>

