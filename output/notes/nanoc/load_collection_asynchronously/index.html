<!doctype html>
<html>
  <head>
    <title>Load a Nanoc Collection Asynchronously</title>
<link type='text/css' href='/style.css' rel='stylesheet'/>
<link rel="stylesheet" href="/css/zenburn.css">
<meta property="og:title" content="Load a Nanoc Collection Asynchronously" />
<meta property="og:url" content="http://www.gabekoss.com/notes/nanoc/load_collection_asynchronously/" />
<meta property="og:type" content="website" />
<meta property="og:description" content="" />
<meta property="og:image" content="http://www.gabekoss.com/images/og.png" />

  <script src="/js/highlight-pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

<!--                                                                                              -->
<!--       ___ ___         .__  .__           ___________      .__                   .___._.      -->
<!--      /   |   \   ____ |  | |  |   ____   \_   _____/______|__| ____   ____    __| _/| |      -->
<!--     /    ~    \_/ __ \|  | |  |  /  _ \   |    __) \_  __ \  |/ __ \ /    \  / __ | | |      -->
<!--     \    Y    /\  ___/|  |_|  |_(  <_> )  |     \   |  | \/  \  ___/|   |  \/ /_/ |  \|      -->
<!--      \___|_  /  \___  >____/____/\____/   \___  /   |__|  |__|\___  >___|  /\____ |  __      -->
<!--            \/       \/                        \/                  \/     \/      \/  \/      -->
<!--                                                                                              -->
<!--                                                                                              -->
<!--     My sweet site was generated using love, ruby & nanoc [http://nanoc.ws/]                  -->
<!--                                                                                              -->
<!--                                                                                              -->
<!--     "Anytime I see something screech across a room and latch onto someones neck,             -->
<!--     and the guy screams and tries to get it off, I have to laugh,                            -->
<!--     because what is that thing?"                                                             -->
<!--                                                                                              -->
<!--                           - Jack Handy                                                       -->
<!--                                                                                              -->

  </head>
  <body>
    <div id="sidebar">
      <ul>
  <li><a href="/">Home</a></li>
  <li><a href="/blog">Blog</a></li>
  <li><a href="/notes">Notes</a></li>
  <li><a href="/tags">Search</a></li>
</ul>
<div class="img-links">
  <a href="https://github.com/granolocks"><img src="/images/github.png"></a>
  <a href="https://twitter.com/granolocks"><img src="/images/twitter.png"></a>
  <div style="clear:both"></div>
</div>

    </div>
    <div id="main">
      
        <h1>Load a Nanoc Collection Asynchronously</h1>
        <p>This assumes that there exists a collection similar to the one outlined in the
notes about <a href="/notes/nanoc/create_a_collection/">generic collection pages</a>.</p>

<h2>Doge Helper</h2>

<p>To manage some of the things that are useful you can create a helper object. </p>

<pre><code class="ruby"># in lib/doge.rb
require &#39;json&#39;
class Doge
  PER_PAGE = 5

  def self.all(items)
    items.select {|i| i[:kind] == &#39;doge-pic&#39; }
  end

   def self.jsonify(doges)
      doges.map! do |doge|
        {
          title:       doge[:title],
          description: doge[:description],
          source:      doge[:source] 
        }
      end
      JSON.generate(doges)
   end

   def self.json_erb
     &quot;&lt;%= Doge.json_erb(@item[:doges].dup) %&gt;&quot;
   end
end
</code></pre>

<h2>Update Rules file</h2>

<p>Update the Rules file to generate the &quot;API&quot; which the Javascript will consume
to load the images.</p>

<pre><code class="ruby">preprocess do 

  def add_doge_api
    doge_pages = []
    Doge.all(@items).each_slice(Doge::PER_PAGE) do |slice| 
      doge_pages &lt;&lt; slice 
    end

    doge_pages.each_with_index do |doges, index|
      @items &lt;&lt; Nanoc::Item.new(
        Doge.json_erb,
        {extension: &quot;erb&quot;,  doges: doges},
        &quot;/api/v1/doge_blog/#{index}.json&quot;
      )
    end
  end

  # Be sure to call it so it gets set up
  add_doge_api
end

compile &#39;/api/v1/doge_blog/*&#39; do
 filter :erb
end

route &#39;/api/v1/doge_blog/*&#39; do
  # remove trailing &#39;/&#39;
  item.identifier.gsub(/\/$/,&#39;&#39;)
end
</code></pre>

<h2>Javascript &#39;Client&#39;</h2>

<p>Okay, I&#39;ll be the first to admit this Javascript is pretty gnarly but hey,
Nanoc is great for one off code and this does the job. Plus no need for Jquery.</p>

<pre><code class="js">// Current Page Number, Should Be &#39;1&#39; When it first loads.
function curPage(){
  return parseInt(document.getElementById(&#39;page-location&#39;).innerText);
}

function getNextPackOfDoges() {
  xhr = new XMLHttpRequest;
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4) {
      if (xhr.status === 200) {
        document.getElementById(&#39;page-location&#39;).innerText = (1 + curPage());
        new_doges = JSON.parse(xhr.response);
        mainDiv = document.getElementById(&quot;main&quot;);
        for (var i in new_doges) {
          doge = new_doges[i];

          var dogeBody;
          dogeBody  = &quot;&quot;;
          dogeBody += &quot;&lt;img src=&#39;&quot;+ doge.source +&quot;&#39; title=&#39;&quot;+ doge.title +&quot;&#39; /&gt;&quot;;
          dogeBody += &quot;&lt;h2&gt;&quot;+ doge.title +&quot;&lt;/h2&gt;&quot;;
          dogeBody += &quot;&lt;p&gt;&quot;+ doge.description +&quot;&lt;/p&gt;&quot;;

          var dogeDiv = document.createElement(&#39;div&#39;);
          dogeDiv.className += &quot;doge-pic&quot;;
          dogeDiv.innerHTML = dogeBody;

          mainDiv.appendChild(dogeDiv);
        }
      } else {
        document.getElementById(&#39;page-location&#39;).innerText = 0;
        mainDiv = document.getElementById(&quot;main&quot;);

        var div = document.createElement(&#39;div&#39;);
        div.className += &quot;no-more-doges&quot;;
        div.innerHTML = &quot;&lt;p style=&#39;text-align:center&#39;&gt;Wow Such end Very sad&lt;/p&gt;&quot;;
        mainDiv.appendChild(div);
      }
    }
  };

  xhr.open(&quot;GET&quot;,&quot;/api/v1/doge_blog/&quot;+curPage()+&quot;.json&quot;,true);
  if (curPage() &gt;= 1) {
    xhr.send();
  }
};

window.onscroll = function(x) {
  if ( curPage() != 0) {
    if ((window.innerHeight + window.scrollY) &gt;= document.body.offsetHeight) {
      getNextPackOfDoges();
    }
  }
}
</code></pre>

<h2>Modify the index</h2>

<p>Update the collection index accordingly </p>

<pre><code class="rb">&lt;% doges = Doge.all(@items)[0..(Doge::PER_PAGE-1)] %&gt;
&lt;% doges.each do |doge| %&gt;
  &lt;div class=&quot;doge-pic&quot;&gt;
    &lt;img src=&quot;&lt;%= doge[:source] %&gt;&quot; title=&quot;&lt;%= doge[:title] %&gt;&quot; /&gt;
    &lt;h2&gt;&lt;%= doge[:title] %&gt;&lt;/h2&gt;
    &lt;p&gt;&lt;%= doge[:description] %&gt;&lt;/p&gt;
  &lt;/div&gt;
&lt;% end %&gt;
&lt;span id=&quot;page-location&quot; style=&quot;display:none;&quot;&gt;1&lt;/div&gt;
&lt;script src=&quot;/js/doge-scroll.js&quot;&gt;&lt;/script&gt;
</code></pre>

<p>The contents of the <code>.page-location</code> span will tell the Javascript that the
first page of additional data to request is page 1.</p>

      
    </div>
    <div id="footer">
      <hr/>
<p>&copy; 2013 <a href="mailto:gabe@gabekoss.com">Gabe Koss</a></p>

  <p><small>Last updated at: 2013-12-07 10:40</small></p>


    </div>
    <script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-12795044-1']);
  _gaq.push(['_setDomainName', 'gabekoss.com']);
  _gaq.push(['_trackPageview']);

  (function() {
   var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
   ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
   var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
   })();
</script>

  </body>
</html>

